<script>
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const url = new URL(window.location.href);
      const sessionId = url.searchParams.get('session_id');
      const endpoint = 'https://123-five-gamma.vercel.app/api/stripebuytofb';

      // Helper function to get a cookie value by name
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
      }

      // Get Facebook cookies if present
      const fbc = getCookie('_fbc');
      const fbp = getCookie('_fbp');

      if (sessionId) {
        console.log('Stripe Session ID found:', sessionId);

        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            sessionId: sessionId,
            source: 'wordpress_direct_html',
            fbc: fbc,
            fbp: fbp
          }),
        });

        const data = await response.json();
        console.log('Vercel function response:', data);

        if (response.ok) {
          console.log('Purchase event successfully sent to Beeceptor.');
        } else {
          console.error('Failed to send purchase event. Server returned:', response.status);
        }
      } else {
        console.warn('Stripe Session ID not found in the URL. Purchase event not sent.');
      }
    } catch (error) {
      console.error('An error occurred:', error);
    }
  });
</script>