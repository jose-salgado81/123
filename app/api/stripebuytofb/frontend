<script>
    var url = new URL(window.location.href);
    var sessionId = url.searchParams.get('session_id');

    if (sessionId) {
        var fbcid = '{{fbcid}}';
        var fbc = '{{fbc}}';
        var fbp = '{{fbp}}';
        var userAgent = navigator.userAgent;
        var sourceUrl = window.location.href;

        // Generate a unique event_id
        var eventId = 'evt_' + Date.now() + '_' + Math.floor(Math.random() * 1000000);

        console.log("Stripe Session ID found:", sessionId);
        console.log("Facebook Tracking Data Captured by GTM:");
        console.log('fbcid: ' + (fbcid || 'Not Found'));
        console.log('fbc: ' + (fbc || 'Not Found'));
        console.log('fbp: ' + (fbp || 'Not Found'));
        console.log("User Agent:", userAgent);
        console.log("Source URL:", sourceUrl);
        console.log("Event ID:", eventId);

        var endpoint = 'https://123-five-gamma.vercel.app/api/stripebuytofb';

        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                sessionId: sessionId,
                source: 'gtm_tag',
                fbc: fbc,
                fbp: fbp,
                userAgent: userAgent,
                fbclid: fbcid,
                sourceUrl: sourceUrl,
                event_id: eventId // Include event_id
            })
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            console.log('Vercel function response:', data);
        })
        .catch(function(error) {
            console.error('An error occurred while sending data to Vercel:', error);
        });

    } else {
        console.warn('Stripe Session ID not found in the URL. CAPI event not sent.');
    }
</script>