<script>
/* GTM Tag Name: "tag link" */
(function() {
  var affiliateDomain = 'freecash.com';
  var fbcValue = '{{fbc}}';
  var fbpValue = '{{fbp}}';

  function appendParamsToLink(link) {
    try {
      var href = link.href;
      var separator = href.indexOf('?') !== -1 ? '&' : '?';
      var newHref = href + separator + 'fbc=' + encodeURIComponent(fbcValue) + '&fbp=' + encodeURIComponent(fbpValue);
      link.href = newHref;
    } catch (e) {
      console.warn('Failed to tag link:', link.href, e);
    }
  }

  function tagAffiliateLinks() {
    var links = document.querySelectorAll('a[href*="' + affiliateDomain + '"]');
    for (var i = 0; i < links.length; i++) {
      appendParamsToLink(links[i]);
    }
  }

  // Run on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', tagAffiliateLinks);
  } else {
    tagAffiliateLinks();
  }

  // Observe dynamically added links
  var observer = new MutationObserver(function(mutations) {
    for (var i = 0; i < mutations.length; i++) {
      var mutation = mutations[i];
      for (var j = 0; j < mutation.addedNodes.length; j++) {
        var node = mutation.addedNodes[j];
        if (node.nodeType === 1) {
          var newLinks = node.querySelectorAll ? node.querySelectorAll('a[href*="' + affiliateDomain + '"]') : [];
          for (var k = 0; k < newLinks.length; k++) {
            appendParamsToLink(newLinks[k]);
          }
        }
      }
    }
  });

  observer.observe(document.body, { childList: true, subtree: true });
})();
</script>
